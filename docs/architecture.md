# wtp Architecture

This document describes the current implementation shape of `wtp`.

## Repository Layout

- CLI entrypoint: `cmd/wtp`
- Core packages:
  - `internal/command`: typed command builders and execution abstraction
  - `internal/git`: git repository/worktree operations and branch resolution
  - `internal/config`: `.wtp.yml` schema, defaults, validation, path resolution
  - `internal/hooks`: post-create hook execution
  - `internal/errors`: user-facing error helpers
  - `internal/io`, `internal/testutil`: output and test helpers

## CLI Composition

`wtp` uses `urfave/cli/v3` and wires these commands in `cmd/wtp/app.go`:

- `add`
- `list`
- `remove`
- `init`
- `cd`
- `hook`
- `shell-init`
- completion command provided by `urfave/cli`

## Command Execution Model

`internal/command` defines a typed command model:

- `Command { Name, Args, WorkDir }`
- `Executor` executes one or more `Command` values in sequence
- builder helpers produce git commands (`worktree add/remove/list`, `branch delete`)

This keeps command construction testable and centralized.

## Git and Branch Resolution

`internal/git.Repository` is the git interaction boundary.

Branch resolution behavior (`ResolveBranch`) is:

1. Use local branch if it exists.
2. Otherwise check matching remote branches.
3. Fail with a helpful error when multiple remotes match.

Worktree discovery uses `git worktree list --porcelain` parsing.

## Configuration and Hooks

Configuration file: `.wtp.yml`.

- Default `base_dir`: `../worktrees`
- Hook types: `copy`, `command`, `symlink`
- Copy hook default: for relative `from`, `to` defaults to `from`

Hook execution (`internal/hooks`) runs post-create hooks in order and streams output.

- Relative paths are constrained under repo/worktree boundaries.
- Command hooks execute in the target worktree by default.
- Hook command environment includes:
  - `GIT_WTP_WORKTREE_PATH`
  - `GIT_WTP_REPO_ROOT`

## Shell Integration

`wtp cd` prints a target path only. It does not `cd` itself.

Shell scripts generated by `wtp hook <shell>` or `wtp shell-init <shell>` wrap `wtp cd` and perform directory changes in the current shell (bash, zsh, fish).

## Tooling

Development commands are managed through `go tool task` (`Taskfile.yml`), with tool versions pinned via the Go tool directive in `go.mod`.
